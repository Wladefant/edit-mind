FROM node:22.20.0

# Configure pnpm
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable && corepack prepare pnpm@10.20.0 --activate

# Install system dependencies for Python and native modules
RUN apt-get update && apt-get install -y \
    python3 python3-venv python3-pip \
    build-essential cmake libopenblas-dev liblapack-dev \
    libx11-dev libgtk-3-dev libboost-all-dev ffmpeg \
    && ln -s /usr/bin/python3 /usr/bin/python \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Install Node.js dependencies
COPY pnpm-workspace.yaml pnpm-lock.yaml package.json prisma.config.ts ./
COPY apps/web/package.json ./apps/web/
COPY apps/background-jobs/package.json ./apps/background-jobs/
COPY packages/shared/package.json ./packages/shared/
COPY packages/prisma/ ./packages/prisma/
COPY scripts/ ./scripts
RUN pnpm install --frozen-lockfile


# Copy only Python requirements
COPY python/requirements.txt /app/python/requirements.txt

# Create venv and install Python dependencies
RUN python3 -m venv /app/.venv
ENV PATH="/app/.venv/bin:$PATH"
RUN pip install --upgrade pip && pip install -r /app/python/requirements.txt

# Copy Node/TS code
COPY apps ./apps
COPY packages ./packages
COPY tsconfig.json ./
RUN pnpm rebuild @tailwindcss/oxide && pnpm rebuild rollup && pnpm rebuild sharp

# Copy the rest of Python code
COPY python /app/python

WORKDIR /app/apps/background-jobs
EXPOSE 4000 8765

# Create cache directory for models
RUN mkdir -p /app/models

# Dev CMD
CMD ["sh", "-c", "pnpm --filter background-jobs build && pnpm --filter background-jobs dev"]
