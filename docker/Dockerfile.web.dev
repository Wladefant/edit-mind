FROM node:22.20.0-slim AS base

# Configure pnpm
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable && corepack prepare pnpm@10.20.0 --activate

# ============================================
# Dependencies stage
# ============================================
FROM base AS dependencies

WORKDIR /app

RUN apt-get update -y && apt-get install -y openssl

# Copy package files for optimal layer caching
COPY pnpm-workspace.yaml pnpm-lock.yaml package.json prisma.config.ts ./
COPY apps/web/package.json ./apps/web/package.json
COPY apps/background-jobs/package.json ./apps/background-jobs/package.json
COPY packages/shared/package.json ./packages/shared/package.json
COPY packages/prisma ./packages/prisma

# Install dependencies
RUN pnpm install --frozen-lockfile

# ============================================
# Build stage
# ============================================
FROM dependencies AS builder

# Copy source code
COPY apps ./apps
COPY packages ./packages
COPY tsconfig.json ./

# Rebuild native modules
RUN pnpm rebuild @tailwindcss/oxide rollup sharp

# Build the web application
RUN pnpm --filter web build

# ============================================
# Development stage
# ============================================
FROM builder AS development

WORKDIR /app/apps/web


EXPOSE 3745

CMD ["pnpm", "--filter", "web", "dev", "--host", "0.0.0.0", "--port", "3745"]